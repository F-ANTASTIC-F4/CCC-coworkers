#!/bin/bash

export LANG=en_US.UTF-8
export LC_ALL=en_US.URF-8

COMMIT_MSG_FILE=$1
ORIGINAL_COMMIT_MSG=$(cat $COMMIT_MSG_FILE)
COMMIT_MSG=$ORIGINAL_COMMIT_MSG

# ì»¤ë°‹ë©”ì„¸ì§€ í˜•ì‹ 
# emoji type: summary
COMMIT_MESSAGE_REGEX="^[^\s]+ [a-z]+: .+"

format_commit_message() {
  # ì´ëª¨ì§€, íƒ€ìž…, ìš”ì•½ ì¶”ì¶œ
  EMOJI=$(echo "$ORIGINAL_COMMIT_MSG" | cut -d ' ' -f1)
  TYPE=$(echo "$ORIGINAL_COMMIT_MSG" | cut -d ' ' -f2 | sed 's/://')
  SUMMARY=$(echo "$ORIGINAL_COMMIT_MSG" | cut -d ':' -f2- | sed 's/^ *//')

  # ì´ëª¨ì§€ ë§µ
  case "$TYPE" in
    feat) EXPECTED_EMOJI="âœ¨";;
    fix|hotfix) EXPECTED_EMOJI="ðŸ›";;
    build) EXPECTED_EMOJI="ðŸ”¨";;
    docs) EXPECTED_EMOJI="ðŸ“";;
    design) EXPECTED_EMOJI="ðŸ’„";;
    merge|Merge) EXPECTED_EMOJI="ðŸ”€";;
    rename) EXPECTED_EMOJI="ðŸšš";;
    style) EXPECTED_EMOJI="ðŸŽ¨";;
    refactor) EXPECTED_EMOJI="â™»ï¸";;
    remove) EXPECTED_EMOJI="ðŸ”¥";;
    test) EXPECTED_EMOJI="âœ…";;
    chore) EXPECTED_EMOJI="ðŸ“¦";;
    *)
      echo "------------------------ERROR------------------------"
      echo "ðŸ¥µ ì˜¬ë°”ë¥¸ ì»¤ë°‹ë©”ì„¸ì§€ íƒ€ìž…ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”(ëŒ€ì†Œë¬¸ìžêµ¬ë¶„) ðŸ¥µ"
      echo "ðŸ‘Œ feat,fix,hotfix,build,docs,design,merge,rename,style,refactor,remove,test,chore ðŸ‘Œ"
      echo
      exit 1
      ;;
  esac
  
  # ì´ëª¨ì§€ì™€ íƒ€ìž…ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
  if [ "$EMOJI" != "$EXPECTED_EMOJI" ]; then
    echo "------------------------ERROR------------------------"
    echo "ðŸ¥µ ì´ëª¨ì§€ì™€ ì»¤ë°‹ë©”ì„¸ì§€ íƒ€ìž…ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ ðŸ¥µ"
    echo "ìž…ë ¥ëœ ì´ëª¨ì§€: $EMOJI"
    echo "ì˜ˆìƒëœ ì´ëª¨ì§€: $EXPECTED_EMOJI (íƒ€ìž…: $TYPE)"
    exit 1
  fi

  COMMIT_MSG="$EMOJI $TYPE: $SUMMARY"
}

validate_commit_message() {
  # í˜•ì‹ ê²€ì¦
  if ! echo "$COMMIT_MSG" | grep -qE "$COMMIT_MESSAGE_REGEX"; then
    echo
    echo "------------------------ERROR------------------------"
    echo "ðŸ¥µ ì»¤ë°‹ ë©”ì‹œì§€ëŠ” 'emoji type: summary' í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤. ë„ì–´ì“°ê¸° í™•ì¸í•´ ì£¼ì„¸ìš”!ðŸ¥µ"
    echo "ðŸ™ ì˜ˆì‹œ: âœ¨ feat: add login feature ðŸ™"
    echo "â—ï¸ (í˜„ìž¬ ì»¤ë°‹ ë©”ì‹œì§€) $COMMIT_MSG â—ï¸"
    exit 1
  fi
}

# Mergeë¡œ ì‹œìž‘í•˜ëŠ” ì»¤ë°‹ì€ í˜•ì‹ ê²€ì‚¬ë¥¼ ìƒëžµ
if ! echo "$ORIGINAL_COMMIT_MSG" | grep -q "^Merge"; then
  validate_commit_message
  format_commit_message
  echo "$COMMIT_MSG" > "$COMMIT_MSG_FILE"
fi

echo
echo 'âœˆï¸ âœˆï¸ âœˆï¸ ðŸ›« wait add jira issue number & Gitmoji ðŸ›¬ âœˆï¸ âœˆï¸ âœˆï¸'

BRANCH_NAME=$(git symbolic-ref -q HEAD)
BRANCH_NAME=${BRANCH_NAME##*/} # Remove everything before the last /
ISSUE_TICKET=$(echo "$BRANCH_NAME" | sed -n 's/^\([A-Z]*-[0-9]*\)-\(.*\)$/\1/p')

if [ -n "$ISSUE_TICKET" ]; then
  COMMIT_MSG="$COMMIT_MSG (Jira Ticket : $ISSUE_TICKET)"
  echo "          Jira í‹°ì¼“ ë²ˆí˜¸: $ISSUE_TICKET / emoji $EMOJI      "
else
  echo "            Jira í‹°ì¼“ ë²ˆí˜¸: âš ï¸ ì—†ì–´ìš” âš ï¸ / emoji $EMOJI      "
fi

echo "$COMMIT_MSG" > $COMMIT_MSG_FILE
echo
echo "ðŸ”† Thanks for keeping the convention ðŸ”†"
echo